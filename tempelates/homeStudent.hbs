<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Quizzie</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F1F6F9;
            --primary: #14274E;
            --secondary: #394867;
            --muted: #9BA4B4;
            --white: #ffffff;
            --card-shadow: 0 2px 16px rgba(20, 39, 78, 0.07);
            --card-radius: 18px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--primary);
            line-height: 1.6;
        }

        /* === HEADER === */
        .header {
            background: var(--white);
            box-shadow: 0 2px 20px rgba(20, 39, 78, 0.06);
            padding: 0.75rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .nav-links {
            display: flex;
            gap: 0.25rem;
            list-style: none;
            background: var(--bg);
            border-radius: 12px;
            padding: 4px;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--muted);
            font-weight: 500;
            font-size: 0.9rem;
            padding: 0.5rem 1.25rem;
            border-radius: 10px;
            transition: all 0.25s;
            cursor: pointer;
        }

        .nav-links a:hover {
            color: var(--secondary);
        }

        .nav-links a.active {
            color: var(--white);
            background: var(--primary);
            box-shadow: 0 2px 8px rgba(20, 39, 78, 0.2);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--secondary);
            font-size: 1.1rem;
            border: none;
        }

        .header-icon:hover {
            background: #e2e8f0;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 0 0 0 3px var(--bg), 0 0 0 5px var(--muted);
            cursor: pointer;
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .profile-info h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
        }

        .profile-info p {
            font-size: 0.7rem;
            color: var(--muted);
        }

        .logout-btn {
            background: #fee2e2;
            color: #ef4444;
            border: none;
            padding: 0.45rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            text-decoration: none;
            margin-left: 0.5rem;
        }

        .logout-btn:hover {
            background: #ef4444;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* === MAIN === */
        .main-content {
            max-width: 1300px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            min-height: calc(100vh - 200px);
        }

        .dashboard-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.75rem;
            letter-spacing: -0.3px;
        }

        /* === BENTO GRID === */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .bento-card {
            background: var(--white);
            border-radius: var(--card-radius);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(155, 164, 180, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .bento-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(20, 39, 78, 0.1);
        }

        .card-statistics {
            grid-column: span 5;
        }

        .card-average {
            grid-column: span 4;
        }

        .card-liveclass {
            grid-column: span 3;
        }

        .card-rankings {
            grid-column: span 5;
        }

        .card-recent-tests {
            grid-column: span 7;
        }

        /* === CARD HEADERS === */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-badge {
            font-size: 0.75rem;
            color: var(--muted);
            background: var(--bg);
            padding: 0.3rem 0.75rem;
            border-radius: 8px;
            font-weight: 500;
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            border: none;
            background: var(--bg);
            color: var(--secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .card-action-btn:hover {
            background: #e2e8f0;
            color: var(--primary);
        }

        .card-action-btn.add-btn:hover {
            background: var(--primary);
            color: white;
        }

        .help-tooltip {
            position: relative;
        }

        .help-tooltip .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.78rem;
            line-height: 1.6;
            width: 260px;
            box-shadow: 0 8px 24px rgba(20, 39, 78, 0.25);
            transition: all 0.25s;
            z-index: 50;
            pointer-events: none;
        }

        .help-tooltip .tooltip-content::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 12px;
            width: 12px;
            height: 12px;
            background: var(--primary);
            transform: rotate(45deg);
        }

        .help-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        /* === STATISTICS CARD === */
        .stats-hero {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .stats-hero-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .stats-hero-unit {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .chart-container {
            position: relative;
            height: 180px;
        }

        /* === AVERAGE MARKS CARD === */
        .avg-hero {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .avg-value {
            font-size: 2.75rem;
            font-weight: 800;
            color: var(--primary);
        }

        .avg-unit {
            font-size: 1rem;
            color: var(--muted);
        }

        .avg-label {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 1rem;
        }

        .progress-bar-track {
            width: 100%;
            height: 8px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .progress-fill-green {
            background: #10b981;
        }

        .progress-fill-yellow {
            background: #f59e0b;
        }

        .progress-fill-red {
            background: #ef4444;
        }

        .mini-stats {
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
        }

        .mini-stat {
            text-align: center;
        }

        .mini-stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.4rem;
            font-size: 1rem;
        }

        .mini-stat-icon.blue {
            background: rgba(20, 39, 78, 0.1);
            color: var(--primary);
        }

        .mini-stat-icon.green {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .mini-stat-icon.orange {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .mini-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .mini-stat-label {
            font-size: 0.7rem;
            color: var(--muted);
        }

        /* === LIVE & RECENT CLASSES === */
        .class-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .class-tab {
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .class-tab.active {
            background: var(--primary);
            color: white;
        }

        .class-tab:not(.active) {
            background: var(--bg);
            color: var(--muted);
        }

        .class-desc {
            font-size: 0.8rem;
            color: var(--muted);
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .class-participants {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .avatar-stack {
            display: flex;
        }

        .avatar-stack span {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 600;
            margin-left: -8px;
            border: 2px solid white;
        }

        .avatar-stack span:first-child {
            margin-left: 0;
        }

        .participants-label {
            font-size: 0.75rem;
            color: var(--muted);
        }

        .course-progress {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .course-progress-label {
            font-size: 0.75rem;
            color: var(--muted);
            white-space: nowrap;
        }

        .course-progress-value {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary);
        }

        .continue-btn {
            width: 100%;
            padding: 0.7rem;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            border: none;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.25s;
        }

        .continue-btn:hover {
            background: var(--secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(20, 39, 78, 0.25);
        }

        /* === RANKINGS === */
        .ranking-list {
            list-style: none;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(155, 164, 180, 0.15);
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .ranking-icon.r1 {
            background: rgba(20, 39, 78, 0.1);
            color: var(--primary);
        }

        .ranking-icon.r2 {
            background: rgba(57, 72, 103, 0.1);
            color: var(--secondary);
        }

        .ranking-icon.r3 {
            background: rgba(155, 164, 180, 0.15);
            color: var(--muted);
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--primary);
        }

        .ranking-detail {
            font-size: 0.72rem;
            color: var(--muted);
        }

        .ranking-score {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--primary);
        }

        /* === RECENT TESTS === */
        .tests-nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tests-nav-btn {
            background: var(--bg);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .tests-nav-btn:hover {
            background: #e2e8f0;
        }

        .tests-today {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary);
        }

        .tests-scroll {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            scroll-snap-type: x mandatory;
        }

        .tests-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .tests-scroll::-webkit-scrollbar-thumb {
            background: var(--muted);
            border-radius: 4px;
        }

        .test-card {
            min-width: 200px;
            padding: 1rem;
            border-radius: 14px;
            background: var(--bg);
            border: 1px solid rgba(155, 164, 180, 0.15);
            scroll-snap-align: start;
            transition: all 0.25s;
            cursor: pointer;
            flex-shrink: 0;
        }

        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(20, 39, 78, 0.1);
        }

        .test-card.highlighted {
            background: var(--primary);
            color: white;
        }

        .test-card.highlighted .test-time,
        .test-card.highlighted .test-title,
        .test-card.highlighted .test-teacher-name {
            color: white;
        }

        .test-card.highlighted .test-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .test-time {
            font-size: 0.72rem;
            color: var(--muted);
            margin-bottom: 0.5rem;
        }

        .test-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .test-badge {
            display: inline-block;
            font-size: 0.65rem;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .test-badge.easy {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .test-badge.medium {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .test-badge.hard {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .test-teacher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: auto;
        }

        .test-teacher-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            font-weight: 600;
        }

        .test-teacher-name {
            font-size: 0.72rem;
            color: var(--muted);
        }

        .test-teacher-role {
            font-size: 0.6rem;
            color: var(--muted);
            opacity: 0.7;
        }

        /* === LIVE QUIZ ALERT === */
        .live-quiz-alert {
            background: linear-gradient(135deg, rgba(20, 39, 78, 0.05), rgba(57, 72, 103, 0.08));
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            animation: liveQuizPulse 2.5s infinite;
            box-shadow: 0 8px 32px rgba(20, 39, 78, 0.1);
            display: none;
        }

        .alert-content {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 1.25rem;
            align-items: center;
        }

        .alert-icon {
            font-size: 1.75rem;
            animation: pulse 1.5s infinite;
        }

        .alert-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.2rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .alert-message {
            color: var(--secondary);
            font-size: 0.85rem;
        }

        .alert-timer {
            text-align: center;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 14px;
            border: 2px solid var(--muted);
            min-width: 110px;
        }

        .timer-label {
            font-size: 0.65rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.2rem;
        }

        .timer-display {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--primary);
            font-family: 'Courier New', monospace;
            line-height: 1;
        }

        .take-live-quiz-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.85rem 1.75rem;
            border-radius: 14px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 14px rgba(20, 39, 78, 0.25);
        }

        .take-live-quiz-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(20, 39, 78, 0.3);
        }

        /* === BUTTONS === */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.25rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            font-size: 0.8rem;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 2px 8px rgba(20, 39, 78, 0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(20, 39, 78, 0.25);
            background: var(--secondary);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: var(--secondary);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #34d399);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .btn-success:hover {
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
        }

        .btn-sm {
            padding: 0.4rem 0.85rem;
            font-size: 0.72rem;
            border-radius: 10px;
        }

        .join-class-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.65rem 1.5rem;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 14px rgba(20, 39, 78, 0.2);
        }

        .join-class-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(20, 39, 78, 0.3);
            background: var(--secondary);
        }

        /* === MODAL === */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(20, 39, 78, 0.4);
            backdrop-filter: blur(8px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 24px 64px rgba(20, 39, 78, 0.2);
            animation: modalSlideIn 0.35s cubic-bezier(.4, 0, .2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.97)
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .close-btn {
            background: var(--bg);
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--muted);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #e2e8f0;
        }

        /* === FORMS === */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid rgba(155, 164, 180, 0.3);
            border-radius: 14px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--bg);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(20, 39, 78, 0.1);
            background: white;
        }

        /* === CLASS PREVIEW === */
        .class-preview {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(155, 164, 180, 0.2);
        }

        .class-preview h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .class-preview-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .preview-stat {
            text-align: center;
            background: white;
            padding: 0.75rem;
            border-radius: 12px;
        }

        .preview-stat-value {
            font-weight: 700;
            color: var(--primary);
        }

        .preview-stat-label {
            font-size: 0.72rem;
            color: var(--muted);
        }

        /* === ALERTS === */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 14px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .alert-info {
            background: rgba(20, 39, 78, 0.05);
            color: var(--primary);
            border: 1px solid rgba(20, 39, 78, 0.15);
        }

        .alert-success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* === NOTIFICATION TOAST === */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 12px 40px rgba(20, 39, 78, 0.3);
            z-index: 1000;
            max-width: 380px;
            animation: slideInRight 0.4s cubic-bezier(.4, 0, .2, 1);
        }

        .toast-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.6rem;
        }

        .toast-icon {
            font-size: 1.35rem;
            animation: pulse 1.5s infinite;
        }

        .toast-title {
            font-weight: 700;
            font-size: 1rem;
        }

        .toast-message {
            font-size: 0.85rem;
            line-height: 1.4;
            margin-bottom: 0.85rem;
            opacity: 0.9;
        }

        .toast-actions {
            display: flex;
            gap: 0.5rem;
        }

        .toast-btn {
            padding: 0.45rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.12);
            color: white;
            cursor: pointer;
            font-size: 0.78rem;
            transition: all 0.2s;
            font-weight: 500;
        }

        .toast-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .toast-btn.primary {
            background: rgba(255, 255, 255, 0.22);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* === FOOTER === */
        .footer {
            background: var(--white);
            border-top: 1px solid rgba(155, 164, 180, 0.2);
            padding: 1.5rem 0;
        }

        .footer-content {
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.825rem;
            color: var(--muted);
        }

        .footer-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: var(--secondary);
        }

        /* === ANIMATIONS === */
        @keyframes liveQuizPulse {

            0%,
            100% {
                box-shadow: 0 8px 32px rgba(20, 39, 78, 0.1)
            }

            50% {
                box-shadow: 0 8px 32px rgba(20, 39, 78, 0.2)
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%)
            }

            to {
                opacity: 1;
                transform: translateX(0)
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.6
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .bento-card {
            animation: fadeInUp 0.5s ease-out both;
        }

        .bento-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .bento-card:nth-child(3) {
            animation-delay: 0.15s;
        }

        .bento-card:nth-child(4) {
            animation-delay: 0.2s;
        }

        .bento-card:nth-child(5) {
            animation-delay: 0.25s;
        }

        /* === RESPONSIVE === */
        @media(max-width:1024px) {
            .bento-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .card-statistics {
                grid-column: span 6;
            }

            .card-average {
                grid-column: span 3;
            }

            .card-liveclass {
                grid-column: span 3;
            }

            .card-rankings {
                grid-column: span 6;
            }

            .card-recent-tests {
                grid-column: span 6;
            }
        }

        @media(max-width:768px) {
            .header-content {
                flex-direction: column;
                gap: 0.75rem;
            }

            .nav-links {
                gap: 0;
            }

            .bento-grid {
                grid-template-columns: 1fr;
            }

            .card-statistics,
            .card-average,
            .card-liveclass,
            .card-rankings,
            .card-recent-tests {
                grid-column: span 1;
            }

            .dashboard-title {
                font-size: 1.35rem;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
                border-radius: 20px;
            }

            .alert-content {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                text-align: center;
            }

            .notification-toast {
                left: 16px;
                right: 16px;
                max-width: none;
                border-radius: 16px;
            }

            .footer-content {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .class-preview-stats {
                grid-template-columns: 1fr;
            }
        }

        @media(max-width:480px) {
            .main-content {
                padding: 1rem 0.75rem;
            }
        }

        /* === LOADING === */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--muted);
        }

        .loading-spinner {
            border: 3px solid var(--bg);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 0.75rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--muted);
        }

        .empty-state h3 {
            font-size: 1.15rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">Quizzie</div>
            <nav>
                <ul class="nav-links">
                    <li><a class="active">Dashboard</a></li>
                    <li><a href="/profileStudent">My Profile</a></li>
                </ul>
            </nav>
            <div class="header-right">
                <button class="header-icon" title="Search"><i data-lucide="search"
                        style="width:18px;height:18px"></i></button>
                <button class="header-icon" title="Notifications"><i data-lucide="bell"
                        style="width:18px;height:18px"></i></button>
                <div class="profile-section">
                    <div class="profile-avatar" id="profileAvatar"></div>
                    <div class="profile-info">
                        <h3>{{userName}}</h3>
                        <p>{{userType}}</p>
                    </div>
                    <a href="/logout" class="logout-btn">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <h1 class="dashboard-title" id="dashboardTitle"></h1>

        <!-- Live Quiz Alert Banner -->
        <div id="liveQuizAlert" class="live-quiz-alert">
            <div class="alert-content">
                <div class="alert-icon"><i data-lucide="radio" style="width:28px;height:28px;color:#ef4444"></i></div>
                <div class="alert-text">
                    <h3 class="alert-title">LIVE QUIZ IN PROGRESS</h3>
                    <p class="alert-message" id="liveQuizMessage">A live quiz is currently active in this class.</p>
                </div>
                <div class="alert-timer">
                    <div class="timer-label">Time Remaining</div>
                    <div class="timer-display" id="liveQuizCountdown">--:--</div>
                </div>
                <div class="alert-action">
                    <button class="take-live-quiz-btn" id="takeLiveQuizBtn" onclick="takeLiveQuiz()"><i
                            data-lucide="rocket"
                            style="width:16px;height:16px;display:inline;vertical-align:middle;margin-right:4px"></i>
                        Take Quiz Now</button>
                </div>
            </div>
        </div>

        <!-- Bento Grid Dashboard -->
        <div class="bento-grid">
            <!-- 1. Statistics Card (top-left) -->
            <div class="bento-card card-statistics">
                <div class="card-header">
                    <span class="card-title"><i data-lucide="bar-chart-3" style="width:20px;height:20px"></i>
                        Statistics</span>
                    <span class="card-badge">Last 7 days</span>
                </div>
                <div class="stats-hero">
                    <span class="stats-hero-value" id="totalQuizzesStat">0</span>
                    <span class="stats-hero-unit">Quizzes taken</span>
                </div>
                <div class="chart-container">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>

            <!-- 2. Average Marks Card (top-center) -->
            <div class="bento-card card-average">
                <div class="card-header">
                    <span class="card-title">Average Marks</span>
                </div>
                <div class="avg-hero">
                    <span class="avg-value" id="avgMarksValue">0%</span>
                    <span class="avg-unit">Total average</span>
                </div>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="avgProgressBar" style="width:0%"></div>
                </div>
                <div class="mini-stats">
                    <div class="mini-stat">
                        <div class="mini-stat-icon blue"><i data-lucide="pencil-line"
                                style="width:16px;height:16px"></i></div>
                        <div class="mini-stat-value" id="inProgressCount">0</div>
                        <div class="mini-stat-label">In progress</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-icon green"><i data-lucide="check-circle"
                                style="width:16px;height:16px"></i></div>
                        <div class="mini-stat-value" id="completedCount">0</div>
                        <div class="mini-stat-label">Completed</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-icon orange"><i data-lucide="calendar-clock"
                                style="width:16px;height:16px"></i></div>
                        <div class="mini-stat-value" id="upcomingCount">0</div>
                        <div class="mini-stat-label">Upcoming</div>
                    </div>
                </div>
            </div>

            <!-- 3. Live & Recent Classes (top-right) -->
            <div class="bento-card card-liveclass">
                <div class="card-header">
                    <span class="card-title"><i data-lucide="book-open" style="width:20px;height:20px"></i>
                        Classes</span>
                    <div class="card-actions">
                        <div class="help-tooltip">
                            <button class="card-action-btn" title="How to join a class">
                                <i data-lucide="help-circle" style="width:16px;height:16px"></i>
                            </button>
                            <div class="tooltip-content">
                                <strong>How to join a class:</strong><br>
                                1. Get a join code from your teacher<br>
                                2. Click the + button<br>
                                3. Enter the 6-digit code<br>
                                4. Wait for teacher approval
                            </div>
                        </div>
                        <button class="card-action-btn add-btn" title="Join New Class" onclick="showJoinClassModal()">
                            <i data-lucide="plus" style="width:18px;height:18px"></i>
                        </button>
                    </div>
                </div>
                <div id="liveClassContent">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <!-- 4. Rankings (bottom-left) -->
            <div class="bento-card card-rankings">
                <div class="card-header">
                    <span class="card-title"><i data-lucide="trophy" style="width:20px;height:20px"></i> Rankings</span>
                </div>
                <ul class="ranking-list" id="rankingsList">
                    <li class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading rankings...</p>
                    </li>
                </ul>
            </div>

            <!-- 5. Recent Tests (bottom-right) -->
            <div class="bento-card card-recent-tests">
                <div class="card-header">
                    <span class="card-title"><i data-lucide="clipboard-list" style="width:20px;height:20px"></i> Recent
                        Tests</span>
                    <div class="tests-nav">
                        <button class="tests-nav-btn" onclick="scrollTests(-1)">‚Äπ</button>
                        <span class="tests-today">Today</span>
                        <button class="tests-nav-btn" onclick="scrollTests(1)">‚Ä∫</button>
                    </div>
                </div>
                <div class="tests-scroll" id="testsScroll">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading tests...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Classes are now shown in the bento grid Classes card -->
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div>¬© 2025 All rights reserved by www.Quizzie.in</div>
            <div><a href="/about-developers" class="footer-link">Meet Our Developers</a></div>
        </div>
    </footer>

    <!-- Join Class Modal -->
    <div id="joinClassModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i data-lucide="graduation-cap"
                        style="width:20px;height:20px;display:inline;vertical-align:middle;margin-right:4px"></i> Join
                    New Class</h2>
                <button class="close-btn" onclick="hideJoinClassModal()">&times;</button>
            </div>
            <div id="joinStep1">
                <div class="form-group">
                    <label class="form-label">Class Join Code</label>
                    <input type="text" id="joinCode" class="form-input" placeholder="Enter 6-digit code (e.g., PHY123)"
                        maxlength="6" style="text-transform:uppercase;">
                    <small style="color:var(--muted);font-size:0.85rem;margin-top:0.5rem;display:block;"><i
                            data-lucide="lightbulb"
                            style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:2px"></i>
                        Ask your
                        teacher for the class join code (expires in 10 minutes)</small>
                </div>
                <div style="display:flex;gap:1rem;margin-top:1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="hideJoinClassModal()">Cancel</button>
                    <button type="button" class="btn" onclick="validateJoinCode()" style="flex:1;">üîç Validate
                        Code</button>
                </div>
            </div>
            <div id="joinStep2" style="display:none;">
                <div id="classPreview" class="class-preview"></div>
                <div style="display:flex;gap:1rem;margin-top:1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="backToStep1()">‚Üê Back</button>
                    <button type="button" class="btn btn-success" onclick="submitJoinRequest()" style="flex:1;">üìù Send
                        Join Request</button>
                </div>
            </div>
            <div id="joinStep3" style="display:none;">
                <div id="requestStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const studentName = '{{{userName}}}';
        let enrolledClasses = [];
        let currentJoinCode = '';
        let currentClassData = {};
        let statsChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Student dashboard initializing...');
            lucide.createIcons();
            initializeDashboard();
            loadEnrolledClasses();
        });

        function initializeDashboard() {
            const hour = new Date().getHours();
            let greeting = 'Good evening';
            if (hour < 12) greeting = 'Good morning';
            else if (hour < 18) greeting = 'Good afternoon';
            document.getElementById('dashboardTitle').textContent = `${greeting}, ${studentName}!`;
            const avatar = document.getElementById('profileAvatar');
            const initials = studentName.split(' ').map(name => name.charAt(0)).join('').toUpperCase();
            avatar.textContent = initials;
        }

        function getSubjectEmoji(subject) {
            const s = subject.toLowerCase();
            if (s.includes('math')) return 'üìê';
            if (s.includes('physic')) return '‚öõÔ∏è';
            if (s.includes('chemistry') || s.includes('chem')) return 'üß™';
            if (s.includes('biology') || s.includes('bio')) return 'üß¨';
            if (s.includes('english') || s.includes('literature')) return 'üìö';
            if (s.includes('history')) return 'üìú';
            if (s.includes('geography')) return 'üåç';
            if (s.includes('computer') || s.includes('programming')) return 'üíª';
            if (s.includes('art')) return 'üé®';
            if (s.includes('music')) return 'üéµ';
            if (s.includes('economics')) return 'üí∞';
            if (s.includes('psychology')) return 'üß†';
            return 'üìñ';
        }

        // ==================== BENTO CARD RENDERERS ====================

        function renderStatisticsChart(classes) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const totalQuizzes = classes.reduce((sum, c) => sum + (c.quizzesTaken || 0), 0);
            document.getElementById('totalQuizzesStat').textContent = totalQuizzes;

            // Generate mock weekly data based on actual quiz count
            const weekData = days.map(() => Math.floor(Math.random() * Math.max(totalQuizzes, 3)));

            const ctx = document.getElementById('statsChart').getContext('2d');
            if (statsChart) statsChart.destroy();
            statsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        data: weekData,
                        backgroundColor: weekData.map((v, i) => i === 4 ? '#14274E' : 'rgba(57,72,103,0.3)'),
                        borderRadius: 6,
                        borderSkipped: false,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false, beginAtZero: true },
                        x: { grid: { display: false }, ticks: { color: '#9BA4B4', font: { size: 11 } }, border: { display: false } }
                    }
                }
            });
        }

        function renderAverageMarks(overallStats, classes) {
            const avg = parseFloat(overallStats?.overallAverage || 0).toFixed(1);
            document.getElementById('avgMarksValue').textContent = avg + '%';

            const bar = document.getElementById('avgProgressBar');
            bar.style.width = avg + '%';
            bar.className = 'progress-bar-fill ' + (avg >= 70 ? 'progress-fill-green' : avg >= 40 ? 'progress-fill-yellow' : 'progress-fill-red');

            const totalAttempts = overallStats?.totalQuizAttempts || 0;
            const totalClasses = overallStats?.totalClasses || classes.length;
            const activeClasses = overallStats?.activeClasses || 0;

            document.getElementById('completedCount').textContent = totalAttempts;
            document.getElementById('inProgressCount').textContent = activeClasses;
            document.getElementById('upcomingCount').textContent = Math.max(0, totalClasses - activeClasses);
        }

        function renderLiveClassCard(classes) {
            const container = document.getElementById('liveClassContent');
            if (classes.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No classes enrolled yet. Click + to join!</p></div>';
                return;
            }
            const cls = classes[0];
            const progress = cls.quizzesTaken > 0 ? Math.min(100, Math.round((cls.averageScore || 0))) : 0;
            container.innerHTML = `
                <div class="class-desc" style="font-weight:600;color:var(--primary);margin-bottom:0.35rem;">${cls.classSubject}</div>
                <div class="class-desc">${cls.className} &bull; ${cls.teacherName}</div>
                <div class="class-participants">
                    <div class="avatar-stack">
                        <span>${cls.teacherName?.charAt(0) || 'T'}</span>
                        <span><i data-lucide="user" style="width:12px;height:12px"></i></span>
                        <span>+</span>
                    </div>
                    <span class="participants-label">Participants</span>
                </div>
                <div class="course-progress">
                    <span class="course-progress-label">Course progress</span>
                    <div class="progress-bar-track" style="flex:1"><div class="progress-bar-fill progress-fill-green" style="width:${progress}%"></div></div>
                    <span class="course-progress-value">${progress}%</span>
                </div>
                <button class="continue-btn" onclick="goToClass('${cls.classId}','${cls.className}')">Continue learning</button>
            `;
            lucide.createIcons();
        }

        async function renderRankings() {
            try {
                const response = await fetch('/api/student/performance-data');
                const data = await response.json();
                const container = document.getElementById('rankingsList');

                if (data.success && data.rankedStudents && data.rankedStudents.length > 0) {
                    const top5 = data.rankedStudents.slice(0, 5);
                    container.innerHTML = top5.map((student, i) => `
                        <li class="ranking-item">
                            <div class="ranking-icon ${i < 3 ? ['r1', 'r2', 'r3'][i] : 'r3'}">${i + 1}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${student.name || 'Student'}</div>
                                <div class="ranking-detail">${student.totalQuizzes || 0} quizzes taken</div>
                            </div>
                            <div class="ranking-score">${(student.averageScore || 0).toFixed(1)}%</div>
                        </li>
                    `).join('');
                } else {
                    container.innerHTML = '<li class="empty-state" style="padding:1rem;"><p>No ranking data yet</p></li>';
                }
            } catch (error) {
                console.error('Error loading rankings:', error);
                document.getElementById('rankingsList').innerHTML = '<li class="empty-state" style="padding:1rem;"><p>Unable to load rankings</p></li>';
            }
        }

        function renderRecentTests(classes) {
            const container = document.getElementById('testsScroll');
            if (classes.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No tests available yet</p></div>';
                return;
            }

            // Build test cards from enrolled classes
            const testCards = classes.slice(0, 6).map((cls, i) => {
                const difficulty = (cls.averageScore || 0) > 70 ? 'easy' : (cls.averageScore || 0) > 40 ? 'medium' : 'hard';
                const diffLabel = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
                const isHighlighted = i === 1;
                return `
                    <div class="test-card ${isHighlighted ? 'highlighted' : ''}" onclick="goToClass('${cls.classId}','${cls.className}')">
                        <div class="test-time">${cls.quizzesTaken || 0} quizzes</div>
                        <div class="test-title">${cls.classSubject}</div>
                        <div class="test-badge ${difficulty}">${diffLabel}</div>
                        <div class="test-teacher">
                            <div class="test-teacher-avatar">${cls.teacherName?.charAt(0) || 'T'}</div>
                            <div>
                                <div class="test-teacher-name">${cls.teacherName || 'Teacher'}</div>
                                <div class="test-teacher-role">Teacher</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = testCards;
        }

        function scrollTests(direction) {
            const container = document.getElementById('testsScroll');
            container.scrollBy({ left: direction * 220, behavior: 'smooth' });
        }

        // ==================== LOAD DATA ====================

        async function loadEnrolledClasses() {
            try {
                const response = await fetch('/api/student/enrolled-classes');
                const data = await response.json();
                if (data.success) {
                    enrolledClasses = data.classes;
                    renderStatisticsChart(data.classes);
                    renderAverageMarks(data.overallStats, data.classes);
                    renderLiveClassCard(data.classes);
                    renderRecentTests(data.classes);
                    renderRankings();
                }
            } catch (error) {
                console.error('Error loading enrolled classes:', error);
            }
        }

        function viewQuizResults(resultId, quizTitle, classId) {
            window.location.href = `/quiz-results/${resultId}?classId=${classId}`;
        }

        function goToClass(classId, className) {
            window.location.href = `/student/class/${classId}`;
        }

        function takeQuiz(quizId, quizTitle, classId) {
            let url = `/quiz-info/${quizId}`;
            if (classId) url += `?classId=${classId}`;
            window.location.href = url;
        }

        // ==================== JOIN CLASS ====================

        function showJoinClassModal() {
            document.getElementById('joinClassModal').classList.add('show');
            resetJoinModal();
            document.getElementById('joinCode').focus();
        }

        function hideJoinClassModal() {
            document.getElementById('joinClassModal').classList.remove('show');
            resetJoinModal();
        }

        function resetJoinModal() {
            document.getElementById('joinStep1').style.display = 'block';
            document.getElementById('joinStep2').style.display = 'none';
            document.getElementById('joinStep3').style.display = 'none';
            document.getElementById('joinCode').value = '';
            currentJoinCode = '';
            currentClassData = {};
        }

        async function validateJoinCode() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            if (!code || code.length !== 6) { showError('Please enter a valid 6-digit join code.'); return; }
            try {
                const response = await fetch(`/api/classes/validate-join-code/${code}`);
                if (!response.ok) { const d = await response.json(); showError(d.message || 'Server error.'); return; }
                const data = await response.json();
                if (data.success) {
                    currentJoinCode = code;
                    currentClassData = data.classInfo;
                    showClassPreview(data.classInfo);
                    document.getElementById('joinStep1').style.display = 'none';
                    document.getElementById('joinStep2').style.display = 'block';
                } else { showError(data.message || 'Invalid or expired join code.'); }
            } catch (e) { showError('Network error. Please try again.'); }
        }

        function showClassPreview(classInfo) {
            document.getElementById('classPreview').innerHTML = `
                <h3 style="color:var(--primary);display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem"><i data-lucide="book-open" style="width:20px;height:20px"></i>${classInfo.classSubject}</h3>
                <p style="color:var(--secondary);font-weight:500;margin-bottom:0.5rem">${classInfo.className}</p>
                <p style="color:var(--muted);font-size:0.85rem;margin-bottom:1rem"><i data-lucide="user" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:4px"></i>${classInfo.teacherName}</p>
                <div class="class-preview-stats">
                    <div class="preview-stat"><div class="preview-stat-value">${classInfo.studentCount || 0}</div><div class="preview-stat-label">Students</div></div>
                    <div class="preview-stat"><div class="preview-stat-value">${classInfo.quizCount || 0}</div><div class="preview-stat-label">Quizzes</div></div>
                    <div class="preview-stat"><div class="preview-stat-value">${Math.floor((classInfo.remainingTime || 0) / 60)}m</div><div class="preview-stat-label">Time Left</div></div>
                </div>
                <div style="background:rgba(20,39,78,0.05);padding:1rem;border-radius:6px;margin-top:1rem;border:1px solid rgba(20,39,78,0.1)">
                    <p style="color:var(--primary);font-size:0.9rem;margin:0"><strong>Join Request:</strong> Your request will be sent to the teacher for approval.</p>
                </div>`;
            lucide.createIcons();
        }

        async function submitJoinRequest() {
            try {
                const response = await fetch('/api/classes/join-request', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ joinCode: currentJoinCode })
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('joinStep2').style.display = 'none';
                    document.getElementById('joinStep3').style.display = 'block';
                    document.getElementById('requestStatus').innerHTML = `
                        <div style="text-align:center;padding:2rem">
                            <div style="margin-bottom:1rem"><i data-lucide="check-circle" style="width:48px;height:48px;color:#10b981"></i></div>
                            <h3 style="color:#10b981;margin-bottom:1rem">Request Sent!</h3>
                            <p style="color:var(--muted);margin-bottom:1.5rem">Your join request for <strong>${currentClassData.classSubject}</strong> has been sent to <strong>${currentClassData.teacherName}</strong>.</p>
                            <button class="btn" onclick="hideJoinClassModal()" style="width:100%">Close</button>
                        </div>`;
                    lucide.createIcons();
                    setTimeout(() => { hideJoinClassModal(); loadEnrolledClasses(); }, 5000);
                } else { showError(data.message || 'Failed to send join request.'); }
            } catch (e) { showError('Network error. Please try again.'); }
        }

        function backToStep1() {
            document.getElementById('joinStep1').style.display = 'block';
            document.getElementById('joinStep2').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('joinCode');
            if (input) input.addEventListener('input', e => { e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, ''); });
        });

        // ==================== ALERTS ====================

        function showSuccess(msg) {
            document.querySelectorAll('.alert').forEach(a => a.remove());
            document.body.insertAdjacentHTML('afterbegin', `<div class="alert alert-success" style="position:fixed;top:20px;right:20px;z-index:1000;max-width:400px"><strong>Success!</strong> ${msg}<button onclick="this.parentElement.remove()" style="float:right;background:none;border:none;font-size:18px;cursor:pointer">&times;</button></div>`);
            setTimeout(() => { const a = document.querySelector('.alert-success'); if (a) a.remove(); }, 8000);
        }


        function showError(msg) {
            document.querySelectorAll('.alert').forEach(a => a.remove());
            document.body.insertAdjacentHTML('afterbegin', `<div class="alert alert-error" style="position:fixed;top:20px;right:20px;z-index:1000;max-width:400px"><strong>Error!</strong> ${msg}<button onclick="this.parentElement.remove()" style="float:right;background:none;border:none;font-size:18px;cursor:pointer">&times;</button></div>`);
            setTimeout(() => { const a = document.querySelector('.alert-error'); if (a) a.remove(); }, 10000);
        }

        // Modal close handlers
        window.onclick = function (e) { if (e.target === document.getElementById('joinClassModal')) hideJoinClassModal(); }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') hideJoinClassModal(); });

        // Auto-refresh
        setInterval(() => { loadEnrolledClasses(); }, 30000);

        // ==================== LIVE QUIZ SYSTEM ====================

        const studentId = '{{{studentId}}}';
        let liveQuizSocket = null;
        let liveQuizTimers = {};
        let currentLiveQuizzes = [];

        function initializeLiveQuizSocket() {
            if (typeof io !== 'undefined') {
                liveQuizSocket = io();
                liveQuizSocket.emit('join-student-rooms', studentId);
                liveQuizSocket.on('live-quiz-notification', function (notification) {
                    handleLiveQuizNotification(notification);
                });
            }
        }

        function handleLiveQuizNotification(notification) {
            switch (notification.type) {
                case 'live_quiz_started': showLiveQuizNotification(notification); loadLiveQuizzes(); break;
                case 'live_quiz_ended': case 'live_quiz_expired': showLiveQuizEndedNotification(notification); loadLiveQuizzes(); break;
            }
        }

        function showLiveQuizNotification(notification) {
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `<div class="toast-header"><span class="toast-icon"><i data-lucide="radio" style="width:18px;height:18px;color:#ef4444"></i></span><span class="toast-title">LIVE QUIZ STARTED!</span></div><div class="toast-message"><strong>${notification.quizTitle}</strong><br>${notification.className}<br>Duration: ${notification.durationMinutes} minutes</div><div class="toast-actions"><button class="toast-btn primary" onclick="goToLiveQuiz('${notification.quizId}')"><i data-lucide="rocket" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:2px"></i> Take Quiz</button><button class="toast-btn" onclick="this.closest('.notification-toast').remove()">Dismiss</button></div>`;
            document.body.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 10000);
            playNotificationSound();
        }

        function showLiveQuizEndedNotification(notification) {
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.style.background = 'linear-gradient(135deg,#f59e0b,#d97706)';
            toast.innerHTML = `<div class="toast-header"><span class="toast-icon"><i data-lucide="clock" style="width:18px;height:18px"></i></span><span class="toast-title">LIVE QUIZ ENDED</span></div><div class="toast-message"><strong>${notification.quizTitle}</strong><br>The live quiz session has ended.</div><div class="toast-actions"><button class="toast-btn" onclick="this.closest('.notification-toast').remove()">OK</button></div>`;
            document.body.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
        }

        async function loadLiveQuizzes() {
            try {
                const response = await fetch('/api/student/live-quizzes');
                const data = await response.json();
                if (data.success) { currentLiveQuizzes = data.liveQuizzes; }
            } catch (e) { console.error('Error loading live quizzes:', e); }
        }

        function showLiveQuizAlert(liveQuiz) {
            const alert = document.getElementById('liveQuizAlert');
            const message = document.getElementById('liveQuizMessage');
            const button = document.getElementById('takeLiveQuizBtn');
            if (!alert) return;
            message.textContent = `${liveQuiz.quizTitle} is currently active. ${liveQuiz.totalQuestions} questions, ${liveQuiz.durationMinutes} minutes total.`;
            button.setAttribute('data-quiz-id', liveQuiz.quizId);
            alert.style.display = 'block';
            startLiveQuizTimer('liveQuizCountdown', liveQuiz.remainingTime);
        }

        function hideLiveQuizAlert() {
            const alert = document.getElementById('liveQuizAlert');
            if (alert) alert.style.display = 'none';
            if (liveQuizTimers['liveQuizCountdown']) { clearInterval(liveQuizTimers['liveQuizCountdown']); delete liveQuizTimers['liveQuizCountdown']; }
        }

        function startLiveQuizTimer(elementId, remainingSeconds) {
            if (liveQuizTimers[elementId]) clearInterval(liveQuizTimers[elementId]);
            let timeLeft = remainingSeconds;
            function update() {
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                const el = document.getElementById(elementId) || document.getElementById(`timer-${elementId}`);
                if (el) {
                    el.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    if (timeLeft <= 60) el.style.color = '#ef4444';
                    else if (timeLeft <= 300) el.style.color = '#f59e0b';
                }
                if (timeLeft <= 0) { clearInterval(liveQuizTimers[elementId]); delete liveQuizTimers[elementId]; setTimeout(() => loadLiveQuizzes(), 1000); }
                timeLeft--;
            }
            update();
            liveQuizTimers[elementId] = setInterval(update, 1000);
        }

        function goToLiveQuiz(quizId) {
            const q = currentLiveQuizzes.find(q => q.quizId === quizId);
            if (q && q.remainingTime <= 0) { alert('This live quiz has expired.'); loadLiveQuizzes(); return; }
            window.location.href = `/quiz-info/${quizId}?live=true`;
        }

        function takeLiveQuiz() {
            const btn = document.getElementById('takeLiveQuizBtn');
            const qid = btn.getAttribute('data-quiz-id');
            if (qid) goToLiveQuiz(qid);
        }

        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator(), gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.setValueAtTime(600, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3);
            } catch (e) { }
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeLiveQuizSocket();
            loadLiveQuizzes();
            setInterval(() => loadLiveQuizzes(), 30000);
        });

        window.addEventListener('beforeunload', () => { Object.values(liveQuizTimers).forEach(t => clearInterval(t)); });
    </script>
</body>

</html>